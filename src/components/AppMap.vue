<template>
  <section ref="map" class="map"></section>
</template>
<style scoped lang="scss">
.map {
  width: 100%;
  height: 100%;
}
</style>
<script>
import GoogleMapsApiLoader from "google-maps-api-loader";

import { getDeviceGeoLocation } from "../utils";
import styles from "../style/google-maps";
import { mapActions, mapState } from "vuex";
import { isEqual, omit } from "lodash";

export const BOUNDARIES_NETHERLANDS = { north: 53.53, south: 50.74, west: 3.35, east: 7.25 };

export default {
  data() {
    return {
      google: null,
      map: null
    };
  },
  computed: {
    ...mapState("ranges", {
      ranges: state => state.ranges
    })
  },
  watch: {
    ranges: function(newValue, oldValue) {
      if (
        !isEqual(
          newValue
            .filter(range => range.originId)
            .map(range => ({ ...omit(range, ["originType"]) })),
          oldValue
            .filter(range => range.originId)
            .map(range => ({ ...omit(range, ["originType"]) }))
        )
      ) {
        this.fetchAreasWithIntersection();
      }
    }
  },
  async mounted() {
    try {
      this.google = await GoogleMapsApiLoader({ apiKey: process.env.VUE_APP_GOOGLE_API_KEY });
    } catch (error) {
      this.$router.push({ name: "error", params: { error } });
      return;
    }

    const center = await getDeviceGeoLocation();

    this.map = new this.google.maps.Map(this.$refs.map, {
      disableDefaultUI: true,
      zoom: 9,
      minZoom: 9,
      center,
      restriction: {
        latLngBounds: BOUNDARIES_NETHERLANDS
      },
      styles
    });
  },
  methods: {
    ...mapActions("ranges", ["fetchAreasWithIntersection"])
  }
};
</script>
